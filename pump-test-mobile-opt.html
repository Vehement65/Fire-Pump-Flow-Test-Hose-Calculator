<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>NFPA 25 Fire Pump Flow Test — Setup (Mobile)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0F172A">
<style>
  :root{
    --bg:#0B1220; --card:#101927; --text:#E5E7EB; --muted:#A5B4CF; --line:#223047;
    --accent:#3B82F6; --accent2:#60A5FA; --ok:#22C55E; --warn:#F97316;
    --pad: clamp(12px, 3.2vw, 18px);
    --r: 14px;
    --shadow: 0 8px 18px rgba(0,0,0,.25);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#F6F8FB; --card:#FFFFFF; --text:#0B1220; --muted:#5A6B85; --line:#E3E8EF;
           --accent:#3E5864; --accent2:#8297A3; --shadow:0 6px 16px rgba(0,0,0,.08); }
  }
  html, body { height: 100%; }
  body{
    margin:0; padding:var(--pad);
    background: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji";
    -webkit-text-size-adjust: 100%;
  }
  .wrap{ max-width: 860px; margin: 0 auto; }
  .card{
    background: var(--card); border: 1px solid var(--line);
    border-radius: var(--r); padding: var(--pad);
    box-shadow: var(--shadow);
  }
  h1{ margin:0 0 8px; font-size: clamp(1.2rem, 5.2vw, 1.7rem); letter-spacing:.2px }
  .subtitle{ color: var(--muted); margin-bottom: 10px; font-size: .95rem; }

  /* Mobile-first grid */
  .grid{ display: grid; gap: 10px; grid-template-columns: 1fr; }
  @media (min-width: 760px){
    .grid.two { grid-template-columns: 1fr 1fr; }
    .grid.three { grid-template-columns: repeat(3, 1fr); }
  }

  label{ font-weight: 700; font-size: .97rem; margin-bottom: 4px; display: block }
  input, select{
    width: 100%; padding: 14px 12px;
    border: 1.5px solid var(--line); border-radius: 12px;
    background: transparent; color: var(--text);
    font-size: 16px; /* prevent iOS zoom */
    -webkit-tap-highlight-color: transparent;
  }
  select option{ color: #0B1220; } /* ensure light text in picker */
  input:focus, select:focus{ outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,.25) }

  .checkrow{ display: grid; gap: 8px; }
  .checkrow label{ display:flex; align-items:center; gap:10px; font-weight:700; }
  .checkrow input[type=checkbox]{ width:22px; height:22px; }

  .bar{
    position: sticky; bottom: calc(env(safe-area-inset-bottom)); left: 0; right: 0; margin-top: 12px;
    background: linear-gradient(180deg, rgba(0,0,0,0), var(--bg) 40%);
    padding-top: 8px; padding-bottom: calc(4px + env(safe-area-inset-bottom));
  }
  .btn{
    width: 100%; appearance:none; border:0; cursor:pointer;
    padding: 16px 18px; border-radius: 12px; font-weight: 800; letter-spacing:.2px;
    color: white; background: linear-gradient(180deg, var(--accent2), var(--accent));
  }
  .results{ display:none; margin-top: 12px }
  .results.show{ display:block; }

  .summary{
    border: 1px solid var(--line); border-radius: 12px; padding: 12px;
    background: linear-gradient(180deg, rgba(96,165,250,.08), transparent 50%);
    margin-bottom: 10px;
  }
  .chips{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap: 8px }
  .chip{ display:flex; gap:8px; align-items:center; padding:10px 12px; border:1px solid var(--line); border-radius: 999px; }

  .cards{ display:grid; gap: 10px }
  .stage{ border:1px solid var(--line); border-radius: 12px; padding: 10px; background: rgba(255,255,255,.02) }
  .stage h3{ margin: 0 0 8px; font-size: 1rem }
  .pill{ display:inline-block; font-size:.78rem; padding:4px 8px; border:1px solid var(--line); border-radius:999px; margin-left:6px }

  .kv{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px }
  @media (min-width: 520px){ .kv{ grid-template-columns: repeat(3, minmax(0,1fr)) } }
  @media (min-width: 820px){ .kv{ grid-template-columns: repeat(6, minmax(0,1fr)) } }
  .box{ text-align:center; border:1px dashed var(--line); border-radius: 10px; padding: 10px }
  .k{ color: var(--muted); font-size: .82rem; margin-bottom: 3px }
  .v{ font-weight:800; font-size: 1.05rem }

  .warning{ display:none; background: rgba(249,115,22,.1); border: 1px solid rgba(249,115,22,.35); color:#FDBA74;
    border-radius: 10px; padding: 10px; font-weight: 700; }

  .fine{ color: var(--muted); font-size:.86rem; margin-top:6px }

  /* reduce motion for perf */
  @media (prefers-reduced-motion: reduce){ *{ animation: none !important; transition: none !important } }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Fire Pump Flow Test — Setup</h1>
    <div class="subtitle">Stage‑smart Auto using FM device curves. Outputs show FM pitot + estimated hose friction.</div>

    <div class="grid">
      <div>
        <label for="mode">Device / Nozzle</label>
        <select id="mode" autocomplete="off">
          <option value="auto" selected>Auto (stage‑smart)</option>
          <option value="2.5">2½″ Full Bore</option>
          <option value="1.75">2½″ 1¾″ Insert</option>
          <option value="1.125">2½″ 1⅛″ Insert</option>
          <option value="2-p">2″ Pitotless (Little HM)</option>
          <option value="1.75-p">1¾″ Pitotless (Little HM)</option>
        </select>
      </div>
      <div class="checkrow">
        <label><input type="checkbox" id="allowIns" checked> Allow 2½″ inserts</label>
        <label><input type="checkbox" id="allowPit"> Allow Pitotless (Little HM)</label>
        <label><input type="checkbox" id="lockDev"> Lock device across stages</label>
      </div>
    </div>

    <div class="grid two" style="margin-top:6px">
      <div>
        <label for="qRated">Pump Rated Flow (GPM)</label>
        <input id="qRated" type="number" value="1000" min="100" step="50" inputmode="numeric" autocomplete="off">
      </div>
      <div>
        <label for="nAvail">Available Devices (count)</label>
        <input id="nAvail" type="number" value="3" min="1" max="12" inputmode="numeric" autocomplete="off">
      </div>
      <div>
        <label for="pRated">Pump Rated Pressure (PSI)</label>
        <input id="pRated" type="number" value="100" min="50" step="5" inputmode="numeric" autocomplete="off">
      </div>
      <div class="grid three">
        <div>
          <label for="pMin">Readable Pitot Min (PSI)</label>
          <input id="pMin" type="number" value="5" min="1" max="50" inputmode="numeric" autocomplete="off">
        </div>
        <div>
          <label for="pMax">Readable Pitot Max (PSI)</label>
          <input id="pMax" type="number" value="30" min="5" max="100" inputmode="numeric" autocomplete="off">
        </div>
        <div>
          <label for="hLen">Hose Length per Line (ft)</label>
          <input id="hLen" type="number" value="50" min="10" max="300" step="5" inputmode="numeric" autocomplete="off">
        </div>
      </div>
      <div>
        <label for="coef">Friction Coefficient C (per 100′)</label>
        <input id="coef" type="number" value="2.0" step="0.1" inputmode="decimal" autocomplete="off">
        <div class="fine">Default C=2.0 for 2½″ test hose.</div>
      </div>
    </div>

    <div class="bar"><button class="btn" id="calc">Calculate</button></div>

    <div id="res" class="results">
      <div id="sum" class="summary" style="display:none">
        <div class="chips">
          <div class="chip"><b>100% device:</b>&nbsp;<span id="sumDev">—</span></div>
          <div class="chip"><b>Hoses @100%:</b>&nbsp;<span id="sumHoses">—</span></div>
          <div class="chip"><b>Pitot @100% (FM):</b>&nbsp;<span id="sumPitot">—</span></div>
        </div>
        <div id="sumProv" class="fine">—</div>
      </div>

      <div class="cards">
        <div class="stage">
          <h3>50% Stage <span id="tag50" class="pill">—</span></h3>
          <div class="kv">
            <div class="box"><div class="k">Hoses</div><div id="hoses50" class="v">—</div></div>
            <div class="box"><div class="k">Pitot (FM)</div><div id="pitot50" class="v">—</div></div>
            <div class="box"><div class="k">PDP ≈ Pitot + FL</div><div id="pdp50" class="v">—</div></div>
            <div class="box"><div class="k">Total Flow</div><div id="flow50" class="v">—</div></div>
            <div class="box"><div class="k">Per Hose</div><div id="per50" class="v">—</div></div>
            <div class="box"><div class="k">Friction Loss</div><div id="fl50" class="v">—</div></div>
          </div>
          <div id="prov50" class="fine">—</div>
        </div>

        <div class="stage">
          <h3>100% Stage <span id="tag100" class="pill">—</span></h3>
          <div class="kv">
            <div class="box"><div class="k">Hoses</div><div id="hoses100" class="v">—</div></div>
            <div class="box"><div class="k">Pitot (FM)</div><div id="pitot100" class="v">—</div></div>
            <div class="box"><div class="k">PDP ≈ Pitot + FL</div><div id="pdp100" class="v">—</div></div>
            <div class="box"><div class="k">Total Flow</div><div id="flow100" class="v">—</div></div>
            <div class="box"><div class="k">Per Hose</div><div id="per100" class="v">—</div></div>
            <div class="box"><div class="k">Friction Loss</div><div id="fl100" class="v">—</div></div>
          </div>
          <div id="prov100" class="fine">—</div>
        </div>

        <div class="stage">
          <h3>150% Stage <span id="tag150" class="pill">—</span></h3>
          <div class="kv">
            <div class="box"><div class="k">Hoses</div><div id="hoses150" class="v">—</div></div>
            <div class="box"><div class="k">Pitot (FM)</div><div id="pitot150" class="v">—</div></div>
            <div class="box"><div class="k">PDP ≈ Pitot + FL</div><div id="pdp150" class="v">—</div></div>
            <div class="box"><div class="k">Total Flow</div><div id="flow150" class="v">—</div></div>
            <div class="box"><div class="k">Per Hose</div><div id="per150" class="v">—</div></div>
            <div class="box"><div class="k">Friction Loss</div><div id="fl150" class="v">—</div></div>
          </div>
          <div id="prov150" class="fine">—</div>
        </div>
      </div>

      <div id="warn" class="warning"></div>
    </div>

    <div class="fine">FM pitot/flow via interpolation; hose friction is an estimate using FL = C·(GPM/100)^2·(L/100). Use calibrated instruments for actual readings.</div>
  </div>
</div>

<script>
const CHARTS={
 "2.5":{label:"2½″ Full Bore",src:"FM HM 2.5 full bore",data:[{psi:5,gpm:377},{psi:6,gpm:413},{psi:7,gpm:446},{psi:8,gpm:477},{psi:9,gpm:506},{psi:10,gpm:533},{psi:11,gpm:559},{psi:12,gpm:584},{psi:13,gpm:608},{psi:14,gpm:631},{psi:15,gpm:653},{psi:16,gpm:675},{psi:17,gpm:695},{psi:18,gpm:716},{psi:19,gpm:735},{psi:20,gpm:754},{psi:21,gpm:773},{psi:22,gpm:791},{psi:23,gpm:809},{psi:24,gpm:826},{psi:25,gpm:843},{psi:26,gpm:860},{psi:27,gpm:876},{psi:28,gpm:893},{psi:29,gpm:908},{psi:30,gpm:924},{psi:35,gpm:998},{psi:40,gpm:1067},{psi:45,gpm:1131},{psi:50,gpm:1193}]},
 "1.75":{label:"2½″ 1¾″ Insert",src:"FM HM insert 1.75″",data:[{psi:5,gpm:199},{psi:6,gpm:218},{psi:7,gpm:236},{psi:8,gpm:252},{psi:9,gpm:268},{psi:10,gpm:282},{psi:11,gpm:295},{psi:12,gpm:308},{psi:13,gpm:321},{psi:14,gpm:333},{psi:15,gpm:345},{psi:16,gpm:356},{psi:17,gpm:367},{psi:18,gpm:378},{psi:19,gpm:388},{psi:20,gpm:398},{psi:21,gpm:408},{psi:22,gpm:418},{psi:23,gpm:427},{psi:24,gpm:436},{psi:25,gpm:445},{psi:26,gpm:454},{psi:27,gpm:463},{psi:28,gpm:471},{psi:29,gpm:479},{psi:30,gpm:488},{psi:35,gpm:527},{psi:40,gpm:563},{psi:45,gpm:597},{psi:50,gpm:630}]},
 "1.125":{label:"2½″ 1⅛″ Insert",src:"FM HM insert 1⅛″",data:[{psi:5,gpm:84},{psi:6,gpm:92},{psi:7,gpm:99},{psi:8,gpm:106},{psi:9,gpm:112},{psi:10,gpm:118},{psi:11,gpm:124},{psi:12,gpm:129},{psi:13,gpm:135},{psi:14,gpm:140},{psi:15,gpm:145},{psi:16,gpm:149},{psi:17,gpm:154},{psi:18,gpm:159},{psi:19,gpm:163},{psi:20,gpm:167},{psi:21,gpm:171},{psi:22,gpm:175},{psi:23,gpm:179},{psi:24,gpm:183},{psi:25,gpm:187},{psi:26,gpm:190},{psi:27,gpm:194},{psi:28,gpm:198},{psi:29,gpm:201},{psi:30,gpm:205},{psi:35,gpm:221},{psi:40,gpm:236},{psi:45,gpm:251},{psi:50,gpm:264}]},
 "2-p":{label:"2″ Pitotless (Little HM)",src:"FM 2″ Pitotless HML",data:[{psi:10,gpm:493},{psi:11,gpm:517},{psi:12,gpm:540},{psi:13,gpm:562},{psi:14,gpm:584},{psi:15,gpm:604},{psi:16,gpm:624},{psi:17,gpm:643},{psi:18,gpm:662},{psi:19,gpm:680},{psi:20,gpm:698},{psi:21,gpm:715},{psi:22,gpm:732},{psi:23,gpm:748},{psi:24,gpm:764},{psi:25,gpm:780},{psi:26,gpm:795},{psi:27,gpm:811},{psi:28,gpm:825},{psi:29,gpm:840},{psi:30,gpm:854},{psi:35,gpm:923},{psi:40,gpm:987},{psi:45,gpm:1046},{psi:50,gpm:1103},{psi:55,gpm:1157},{psi:60,gpm:1208},{psi:65,gpm:1258},{psi:70,gpm:1305}]},
 "1.75-p":{label:"1¾″ Pitotless (Little HM)",src:"FM 1¾″ Pitotless HML",data:[{psi:5.2,gpm:250},{psi:10,gpm:331},{psi:11,gpm:347},{psi:12,gpm:363},{psi:13,gpm:378},{psi:14,gpm:392},{psi:15,gpm:406},{psi:16,gpm:419},{psi:17,gpm:432},{psi:18,gpm:444},{psi:19,gpm:456},{psi:20,gpm:468},{psi:21,gpm:480},{psi:22,gpm:491},{psi:23,gpm:502},{psi:24,gpm:513},{psi:25,gpm:524},{psi:26,gpm:534},{psi:27,gpm:544},{psi:28,gpm:554},{psi:29,gpm:564},{psi:30,gpm:573},{psi:35,gpm:619},{psi:40,gpm:662},{psi:45,gpm:702},{psi:50,gpm:740},{psi:55,gpm:776},{psi:60,gpm:811},{psi:65,gpm:844},{psi:70,gpm:876},{psi:75,gpm:907},{psi:80,gpm:936}]}
};
function psiFromFlow(key,g){const d=CHARTS[key].data; if(g<=d[0].gpm)return{psi:d[0].psi,clamped:true}; if(g>=d[d.length-1].gpm)return{psi:d[d.length-1].psi,clamped:true};
 for(let i=0;i<d.length-1;i++){const a=d[i],b=d[i+1]; if(g>=a.gpm&&g<=b.gpm){const r=(g-a.gpm)/(b.gpm-a.gpm); return{psi:a.psi+r*(b.psi-a.psi),clamped:false};}} return{psi:null};}
function pickHoses(key,QT,N,minP,maxP){let best=null,mid=(minP+maxP)/2; for(let h=1;h<=N;h++){const q=QT/h; const {psi,clamped}=psiFromFlow(key,q); if(psi==null)continue; const inW=(psi>=minP&&psi<=maxP); const delta=Math.abs(psi-mid); const cand={h:h,q:q,psi:psi,inW:inW,delta:delta,clamped:clamped}; if(!best)best=cand; else if(cand.inW&&!best.inW)best=cand; else if(cand.inW===best.inW){ if(cand.h<best.h)best=cand; else if(cand.h===best.h&&cand.delta<best.delta)best=cand; } } return best;}
function allowedSet(insOK,pitOK){const set=['2.5']; if(insOK)set.push('1.75','1.125'); if(pitOK)set.push('2-p','1.75-p'); return set;}
function bestDeviceForStage(QT,N,minP,maxP,insOK,pitOK){let best=null; const keys=allowedSet(insOK,pitOK); for(const k of keys){const plan=pickHoses(k,QT,N,minP,maxP); if(!plan)continue; const score=(plan.inW?2:1)-(plan.h*0.01)-(plan.delta*0.001); if(!best||score>best._s){best={key:k,plan:plan,_s:score};}} return best;}
function friction(C,q,L){return C*Math.pow(q/100,2)*(L/100);}
function fmtPSI(x){return isFinite(x)?x.toFixed(1)+' PSI':'—'} function fmtGPM(x){return isFinite(x)?Math.round(x)+' GPM':'—'}
function write(stage,plan,key,QT,C,L,pRated,minP,maxP){
  const hoses=document.getElementById('hoses'+stage),pitot=document.getElementById('pitot'+stage),pdp=document.getElementById('pdp'+stage),
    flow=document.getElementById('flow'+stage),per=document.getElementById('per'+stage),fl=document.getElementById('fl'+stage),
    prov=document.getElementById('prov'+stage),tag=document.getElementById('tag'+stage);
  if(!plan){ hoses.textContent='—'; pitot.textContent='—'; pdp.textContent='—'; flow.textContent=fmtGPM(QT); per.textContent='—'; fl.textContent='—'; prov.textContent='—'; tag.textContent='—'; return {warn:`Stage ${stage}%: No valid option in allowed devices.`};}
  const flv=friction(C,plan.q,L); const pdpV=(plan.psi||0)+flv;
  hoses.textContent=plan.h; pitot.textContent=fmtPSI(plan.psi); pdp.textContent=fmtPSI(pdpV);
  flow.textContent=fmtGPM(QT); per.textContent=fmtGPM(plan.q); fl.textContent=fmtPSI(flv);
  prov.textContent=CHARTS[key].src; tag.textContent=CHARTS[key].label;
  let w=[]; if(plan.clamped)w.push(`Stage ${stage}%: Per‑hose flow outside FM chart; clamped.`);
  if(!(plan.psi>=minP&&plan.psi<=maxP))w.push(`Stage ${stage}%: Pitot ${plan.psi.toFixed(1)} PSI outside ${minP}-${maxP} PSI.`);
  if(pdpV>pRated*1.5)w.push(`Stage ${stage}%: PDP ${pdpV.toFixed(1)} PSI >> rated ${pRated} PSI.`);
  return {warn:w.join('\n• ')};
}
function run(){
  const mode=document.getElementById('mode').value, insOK=document.getElementById('allowIns').checked, pitOK=document.getElementById('allowPit').checked, lock=document.getElementById('lockDev').checked;
  const Qr=parseFloat(document.getElementById('qRated').value), N=parseInt(document.getElementById('nAvail').value,10),
        pRated=parseFloat(document.getElementById('pRated').value), minP=parseFloat(document.getElementById('pMin').value),
        maxP=parseFloat(document.getElementById('pMax').value), L=parseFloat(document.getElementById('hLen').value),
        C=parseFloat(document.getElementById('coef').value)||2.0;
  const res=document.getElementById('res'), sum=document.getElementById('sum'), warn=document.getElementById('warn'),
        sumDev=document.getElementById('sumDev'), sumH=document.getElementById('sumHoses'), sumP=document.getElementById('sumPitot'), sumProv=document.getElementById('sumProv');
  warn.style.display='none'; warn.textContent=''; sum.style.display='none';
  if(!Qr||!N||!pRated||!minP||!maxP||!L){ alert('Please fill in all fields.'); return; }
  const stages=[{lab:'50',m:0.5},{lab:'100',m:1.0},{lab:'150',m:1.5}];
  let keyAll=null, plan100=null;
  function chooseKey(QT){
    if(mode==='auto'){ if(lock){ return keyAll; } const b=bestDeviceForStage(QT,N,minP,maxP,insOK,pitOK); return b?b.key:null; }
    return mode;
  }
  if(mode==='auto' && lock){
    const b = bestDeviceForStage(Qr*1.0,N,minP,maxP,insOK,pitOK);
    if(b){ keyAll=b.key; plan100=b.plan; }
  }
  // Summary @ 100%
  const k100 = chooseKey(Qr*1.0);
  const p100 = plan100 || (k100? pickHoses(k100,Qr*1.0,N,minP,maxP): null);
  if(k100 && p100){ sum.style.display='block'; sumDev.textContent=CHARTS[k100].label; sumH.textContent=p100.h; sumP.textContent=fmtPSI(p100.psi); sumProv.textContent=CHARTS[k100].src; }

  let warnings=[];
  for(const st of stages){
    const QT=Qr*st.m; const key=chooseKey(QT); const plan= key? pickHoses(key,QT,N,minP,maxP): null;
    const r = write(st.lab,plan,key||'2.5',QT,C,L,pRated,minP,maxP);
    if(r.warn)warnings.push(r.warn);
  }
  if(warnings.length){ warn.style.display='block'; warn.textContent='⚠️ '+warnings.join('\n• '); }
  res.classList.add('show');
}
document.getElementById('calc').addEventListener('click', run);
window.addEventListener('load', run);
</script>
</body>
</html>
